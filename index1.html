<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Metalero con joystick y apuntado táctil</title>
<style>
  body {
    margin: 0;
    background: #111;
    font-family: sans-serif;
    color: white;
    user-select: none;
    overflow: hidden;
  }
  #infoText {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 14px;
    max-width: 90vw;
    text-align: center;
    z-index: 15;
    line-height: 1.2;
  }
  #score {
    position: absolute;
    top: 50px;
    left: 50%;
    transform: translateX(-50%);
    font-family: monospace;
    font-size: 18px;
    z-index: 15;
  }
  canvas {
    display: block;
    margin: 80px auto 0;
    background: #222;
    border: 2px solid #555;
    touch-action: none;
    max-width: 100vw;
  }
  #pauseOverlay {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.75);
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    color: white;
    font-size: 24px;
    font-weight: bold;
    user-select: none;
    visibility: hidden;
    z-index: 100;
  }
  #resumeBtn {
    margin-top: 20px;
    padding: 10px 20px;
    background: #a22;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
    border-radius: 5px;
  }
  #resumeBtn:hover {
    background: #d33;
  }
  /* Botón pausa arriba derecha */
  #btnPauseMobile {
    position: fixed;
    top: 10px;
    right: 10px;
    background: #a22;
    width: 50px;
    height: 50px;
    border-radius: 8px;
    font-size: 24px;
    line-height: 50px;
    text-align: center;
    cursor: pointer;
    z-index: 30;
    user-select: none;
    box-shadow: 0 0 10px #700;
  }
  #btnPauseMobile:active {
    background: #d33;
    box-shadow: 0 0 15px #d33;
  }
  /* Joystick */
  #joystickContainer {
    position: fixed;
    bottom: 20px;
    left: 20px;
    width: 120px;
    height: 120px;
    touch-action: none;
    user-select: none;
    z-index: 25;
  }
  #joystickBase {
    width: 120px;
    height: 120px;
    background: #444;
    border-radius: 50%;
    opacity: 0.6;
    position: relative;
  }
  #joystickStick {
    width: 60px;
    height: 60px;
    background: #a22;
    border-radius: 50%;
    position: absolute;
    left: 30px;
    top: 30px;
    box-shadow: 0 0 10px #700;
    touch-action: none;
  }
</style>
</head>
<body>
  <div id="infoText">
    Mueve con joystick a la izquierda<br>
    Apunta y dispara tocando en pantalla<br>
    P para pausar o botón arriba derecha
  </div>
  <div id="score">Puntaje: 0</div>
  <canvas id="game" width="600" height="400"></canvas>

  <div id="pauseOverlay">
    <div>Juego en pausa</div>
    <button id="resumeBtn">Reanudar</button>
  </div>

  <div id="btnPauseMobile" title="Pausar">⏸</div>

  <div id="joystickContainer">
    <div id="joystickBase">
      <div id="joystickStick"></div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');

  // Jugador
  const player = {
    x: canvas.width / 2,
    y: canvas.height - 60,
    speed: 5,
    vx: 0
  };

  // Puntero para apuntar y disparar
  const pointer = {
    x: canvas.width / 2,
    y: canvas.height / 2,
    down: false
  };

  // Control de teclas para PC
  const keys = {
    left: false,
    right: false
  };

  // Bullets y enemigos
  const bullets = [];
  const enemies = [];

  let score = 0;
  let lastShot = 0;
  const fireRate = 200;

  let gamePaused = false;
  let animationFrameId = null;
  let spawnInterval = null;
  let gameOver = false;

  const pauseOverlay = document.getElementById('pauseOverlay');
  const resumeBtn = document.getElementById('resumeBtn');
  const btnPauseMobile = document.getElementById('btnPauseMobile');

  // Joystick elementos
  const joystickContainer = document.getElementById('joystickContainer');
  const joystickStick = document.getElementById('joystickStick');
  const joystickBase = document.getElementById('joystickBase');

  // Variables joystick
  let joystickActive = false;
  let joystickCenter = { x: 0, y: 0 };
  let joystickPos = { x: 0, y: 0 };

  // Inicializar joystick center cuando se cargue
  function initJoystickCenter() {
    const rect = joystickBase.getBoundingClientRect();
    joystickCenter.x = rect.left + rect.width / 2;
    joystickCenter.y = rect.top + rect.height / 2;
    resetJoystick();
  }

  // Reset joystick a centro
  function resetJoystick() {
    joystickStick.style.transform = 'translate(0px, 0px)';
    joystickPos.x = 0;
    joystickPos.y = 0;
    keys.left = false;
    keys.right = false;
  }

  // Actualizar movimiento jugador según joystickPos.x (-1 a 1)
  function updatePlayerFromJoystick() {
    if (joystickPos.x < -0.3) {
      keys.left = true;
      keys.right = false;
    } else if (joystickPos.x > 0.3) {
      keys.left = false;
      keys.right = true;
    } else {
      keys.left = false;
      keys.right = false;
    }
  }

  // Eventos joystick touch
  joystickBase.addEventListener('touchstart', e => {
    e.preventDefault();
    joystickActive = true;
    initJoystickCenter();
    handleJoystickMove(e.touches[0]);
  }, {passive: false});

  joystickBase.addEventListener('touchmove', e => {
    e.preventDefault();
    if (!joystickActive) return;
    handleJoystickMove(e.touches[0]);
  }, {passive: false});

  joystickBase.addEventListener('touchend', e => {
    e.preventDefault();
    joystickActive = false;
    resetJoystick();
  }, {passive: false});

  joystickBase.addEventListener('touchcancel', e => {
    e.preventDefault();
    joystickActive = false;
    resetJoystick();
  }, {passive: false});

  function handleJoystickMove(touch) {
    const dx = touch.clientX - joystickCenter.x;
    const dy = touch.clientY - joystickCenter.y;

    // Máximo desplazamiento stick 50px (radio)
    const maxDist = 50;
    let dist = Math.sqrt(dx * dx + dy * dy);
    if (dist > maxDist) dist = maxDist;

    // Ángulo para desplazar stick dentro del círculo
    const angle = Math.atan2(dy, dx);

    const stickX = Math.cos(angle) * dist;
    const stickY = Math.sin(angle) * dist;

    joystickStick.style.transform = `translate(${stickX}px, ${stickY}px)`;

    joystickPos.x = stickX / maxDist; // -1 a 1
    joystickPos.y = stickY / maxDist;

    updatePlayerFromJoystick();
  }

  // Eventos teclado PC
  window.addEventListener('keydown', e => {
    if (e.key === 'a' || e.key === 'ArrowLeft') keys.left = true;
    if (e.key === 'd' || e.key === 'ArrowRight') keys.right = true;
    if (e.key.toLowerCase() === 'p') {
      if (gamePaused) resumeGame();
      else pauseGame();
    }
  });
  window.addEventListener('keyup', e => {
    if (e.key === 'a' || e.key === 'ArrowLeft') keys.left = false;
    if (e.key === 'd' || e.key === 'ArrowRight') keys.right = false;
  });

  // Apuntar con mouse y disparar con click
  canvas.addEventListener('mousemove', e => {
    const rect = canvas.getBoundingClientRect();
    pointer.x = e.clientX - rect.left;
    pointer.y = e.clientY - rect.top;
  });
  canvas.addEventListener('mousedown', e => {
    if (e.button === 0) pointer.down = true;
  });
  canvas.addEventListener('mouseup', e => {
    if (e.button === 0) pointer.down = false;
  });

  // Apuntar y disparar con touch (solo la primera finger para disparar)
  canvas.addEventListener('touchstart', e => {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches[0];
    pointer.x = touch.clientX - rect.left;
    pointer.y = touch.clientY - rect.top;
    pointer.down = true;
  }, {passive: false});
  canvas.addEventListener('touchmove', e => {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches[0];
    pointer.x = touch.clientX - rect.left;
    pointer.y = touch.clientY - rect.top;
  }, {passive: false});
  canvas.addEventListener('touchend', e => {
    e.preventDefault();
    pointer.down = false;
  }, {passive: false});

  // Botón pausa
  btnPauseMobile.addEventListener('click', () => {
    if (gamePaused) resumeGame();
    else pauseGame();
  });

  // Función disparar bala
  function shoot() {
    const dx = pointer.x - player.x;
    const dy = pointer.y - player.y;
    const mag = Math.hypot(dx, dy);
    if(mag === 0) return; // evitar división por 0
    const vx = (dx / mag) * 6;
    const vy = (dy / mag) * 6;
    bullets.push({ x: player.x, y: player.y, vx, vy });
  }

  // Crear enemigo nuevo arriba con posición aleatoria
  function spawnEnemy() {
    const x = Math.random() * (canvas.width - 30);
    enemies.push({ x, y: -30, size: 30, speed: 2 + Math.random() * 2 });
  }

  // Empezar/parar spawn
  function startSpawning() {
    spawnInterval = setInterval(spawnEnemy, 1000);
  }
  function stopSpawning() {
    clearInterval(spawnInterval);
  }

  // Actualizar estado del juego
  function update() {
    if (gameOver) return;

    // Movimiento jugador según teclas (o joystick)
    if (keys.left) player.vx = -player.speed;
    else if (keys.right) player.vx = player.speed;
    else player.vx = 0;

    player.x += player.vx;

    // Limitar dentro canvas
    if (player.x < 15) player.x = 15;
    if (player.x > canvas.width - 15) player.x = canvas.width - 15;

    const now = Date.now();

    // Disparar si puntero presionado y respeta fireRate
    if (pointer.down && now - lastShot > fireRate) {
      shoot();
      lastShot = now;
    }

    // Actualizar balas
    bullets.forEach((b, i) => {
      b.x += b.vx;
      b.y += b.vy;
      if (b.x < 0 || b.x > canvas.width || b.y < 0 || b.y > canvas.height) {
        bullets.splice(i, 1);
      }
    });

    // Actualizar enemigos y detectar colisión con jugador
    enemies.forEach((e, i) => {
      e.y += e.speed;

      // Quitar enemigos que bajaron del canvas
      if (e.y > canvas.height) enemies.splice(i, 1);

      // Colisión jugador-enemigo (rectángulos)
      const playerLeft = player.x - 15;
      const playerRight = player.x + 15;
      const playerTop = player.y - 30;
      const playerBottom = player.y + 30;

      const enemyLeft = e.x;
      const enemyRight = e.x + e.size;
      const enemyTop = e.y;
      const enemyBottom = e.y + e.size;

      const collision = !(playerRight < enemyLeft ||
                          playerLeft > enemyRight ||
                          playerBottom < enemyTop ||
                          playerTop > enemyBottom);

      if (collision) {
        gameOver = true;
        pauseGame();
        alert('¡Perdiste! Tu puntaje final: ' + score);
      }
    });

    // Colisión balas-enemigos para eliminar enemigo y sumar puntos
    enemies.forEach((e, ei) => {
      bullets.forEach((b, bi) => {
        if (
          b.x > e.x &&
          b.x < e.x + e.size &&
          b.y > e.y &&
          b.y < e.y + e.size
        ) {
          enemies.splice(ei, 1);
          bullets.splice(bi, 1);
          score++;
          document.getElementById('score').textContent = `Puntaje: ${score}`;
        }
      });
    });
  }

  // Dibujar todo
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Ángulo para rotar jugador hacia puntero
    const angle = Math.atan2(pointer.y - player.y, pointer.x - player.x);
    ctx.save();
    ctx.translate(player.x, player.y);
    ctx.rotate(angle);

    // Guitarra
    ctx.fillStyle = '#a22';
    ctx.fillRect(10, -5, 40, 10);
    ctx.beginPath();
    ctx.arc(50, 0, 10, 0, Math.PI * 2);
    ctx.fill();

    // Cuerpo
    ctx.fillStyle = '#333';
    ctx.fillRect(-15, -30, 30, 60);

    // Cabeza
    ctx.beginPath();
    ctx.fillStyle = '#f0c89e';
    ctx.arc(0, -40, 15, 0, Math.PI * 2);
    ctx.fill();

    ctx.restore();

    // Balas
    ctx.fillStyle = 'yellow';
    bullets.forEach(b => {
      ctx.beginPath();
      ctx.arc(b.x, b.y, 4, 0, Math.PI * 2);
      ctx.fill();
    });

    // Enemigos
    ctx.fillStyle = 'red';
    enemies.forEach(e => {
      ctx.fillRect(e.x, e.y, e.size, e.size);
    });

    // Mira (puntero)
    ctx.strokeStyle = 'white';
    ctx.beginPath();
    ctx.arc(pointer.x, pointer.y, 5, 0, Math.PI * 2);
    ctx.stroke();
  }

  // Bucle principal
  function gameLoop() {
    if (!gamePaused) {
      update();
      draw();
      animationFrameId = requestAnimationFrame(gameLoop);
    }
  }

  // Pausar juego
  function pauseGame() {
    gamePaused = true;
    pauseOverlay.style.visibility = 'visible';
    stopSpawning();
    if (animationFrameId) cancelAnimationFrame(animationFrameId);
  }

  // Reanudar juego (o reiniciar si perdió)
  function resumeGame() {
    if (gameOver) {
      score = 0;
      gameOver = false;
      bullets.length = 0;
      enemies.length = 0;
      document.getElementById('score').textContent = `Puntaje: ${score}`;
    }
    gamePaused = false;
    pauseOverlay.style.visibility = 'hidden';
    startSpawning();
    gameLoop();
  }

  resumeBtn.addEventListener('click', resumeGame);

  // También pausar/reanudar con P
  window.addEventListener('keydown', e => {
    if (e.key.toLowerCase() === 'p') {
      if (gamePaused) resumeGame();
      else pauseGame();
    }
  });

  // Inicializar joystick cuando cargue la página
  initJoystickCenter();

  // Iniciar enemigos y loop
  startSpawning();
  gameLoop();
});
</script>
</body>
</html>
